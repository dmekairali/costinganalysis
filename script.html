<script>
// =================================================================================
// Global Variables & State Management
// =================================================================================
let sfgCostingData = [];
let fgCostingData = [];
let sfgFilteredCostingData = [];
let fgFilteredCostingData = [];
let sfgDataTable = null;
let fgDataTable = null;
let activeSystem = 'sfg'; // 'sfg' or 'fg'
let sfgLastRefresh = null;
let fgLastRefresh = null;
let currentEditContext = null; // To store { rowIndex, fieldPath } for the modal

// =================================================================================
// Initialization
// =================================================================================
$(document).ready(initializeDashboard);

function initializeDashboard() {
    showLoading(true);
    const sfgPromise = new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).importSfgData();
    });
    const fgPromise = new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).importFgData();
    });

    Promise.all([sfgPromise, fgPromise]).then(([sfgData, fgData]) => {
        sfgCostingData = sfgData || [];
        sfgFilteredCostingData = sfgData || [];
        sfgLastRefresh = new Date();
        fgCostingData = fgData || [];
        fgFilteredCostingData = fgData || [];
        fgLastRefresh = new Date();

        const dataTableConfig = {
            "scrollY": "75vh", "scrollX": true, "scrollCollapse": true, "paging": false,
            "ordering": true, "info": false, "fixedHeader": { "header": true, "headerOffset": 50 }
        };
        sfgDataTable = $('#costing-table-sfg').DataTable(dataTableConfig);
        fgDataTable = $('#costing-table-fg').DataTable(dataTableConfig);
        
        attachEventListeners();
        switchTab('sfg');
        showLoading(false);
    }).catch(error => {
        console.error('Error importing data:', error);
        showNotification('Failed to load data from one or more Google Sheets.', 'error');
        showLoading(false);
    });
}

// =================================================================================
// Tab & UI Logic
// =================================================================================
function switchTab(system) {
    activeSystem = system;
    
    // Deactivate all tabs and content first
    $('.tab-button').removeClass('active');
    $('.system-container').removeClass('active');

    // Activate the selected tab and content
    $(`#${system}-tab`).addClass('active');
    $(`#${system}-content`).addClass('active');

    populateTable();
    updateMLInsights();
    updateRefreshTimestamp();
}

function updateRefreshTimestamp() {
    const { lastRefresh, timestampElementId } = getActiveSystemContext();
    if (lastRefresh) {
        const timeString = lastRefresh.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        $(timestampElementId).text(`Last loaded: ${timeString}`);
    } else {
        $(timestampElementId).text('');
    }
}

function getActiveSystemContext() {
    if (activeSystem === 'sfg') {
        return {
            costingData: sfgCostingData, filteredData: sfgFilteredCostingData, dataTable: sfgDataTable,
            lastRefresh: sfgLastRefresh, saveFunc: 'saveSfgData', importFunc: 'importSfgData',
            deviationFilterIds: { ca: '#ca-deviation-filter-sfg', toc: '#toc-deviation-filter-sfg', time: '#time-deviation-filter-sfg' },
            timestampElementId: '#sfg-refresh-time'
        };
    } else {
        return {
            costingData: fgCostingData, filteredData: fgFilteredCostingData, dataTable: fgDataTable,
            lastRefresh: fgLastRefresh, saveFunc: 'saveFgData', importFunc: 'importFgData',
            deviationFilterIds: { ca: '#ca-deviation-filter-fg', toc: '#toc-deviation-filter-fg', time: '#time-deviation-filter-fg' },
            timestampElementId: '#fg-refresh-time'
        };
    }
}

// =================================================================================
// Data Population and Display
// =================================================================================
function populateTable() {
    const { filteredData, costingData, dataTable } = getActiveSystemContext();
    if (!dataTable) return;

    dataTable.clear();
    const rows = filteredData.map((item, index) => {
        const originalIndex = costingData.findIndex(d => d.productionId === item.productionId);
        return [
            `<strong>${item.productName}</strong>`, item.productionId, item.package, item.qty.toLocaleString(),
            `<div class="notes-col">${item.notes}</div>`, `<div class="ai-notes-col">${item.aiNotes || ''}</div>`,
            ...createCostSectionRow(item, 'ca', originalIndex),
            ...createCostSectionRow(item, 'toc', originalIndex),
            ...createCostSectionRow(item, 'time', originalIndex)
        ];
    });
    dataTable.rows.add(rows).draw(false);
}

function createCostSectionRow(item, section, originalIndex) {
    const isTime = section === 'time';
    const deviation = isTime ? calculateTimeDeviation(item[section].benchmark, item[section].newBenchmark) : calculateDeviation(item[section].benchmark, item[section].newBenchmark);
    const format = (val) => isTime ? val : `â‚¹${val.toFixed(2)}`;

    return [
        `<div class="cost-cell editable-cell" onclick="openEditModal(${originalIndex}, '${section}.correct')">${format(item[section].correct)}</div>`,
        `<div class="cost-cell">${format(item[section].benchmark)}</div>`,
        `<div class="cost-cell">${format(item[section].last3Prod)}</div>`,
        `<div class="cost-cell">${format(item[section].last3Month)}</div>`,
        `<div class="cost-cell">${format(item[section].last12Month)}</div>`,
        `<div class="cost-cell editable-cell" onclick="openEditModal(${originalIndex}, '${section}.newBenchmark')">${format(item[section].newBenchmark)}</div>`,
        `<div class="deviation-cell">${deviation}</div>`,
        `<div class="status-cell ${getStatusClass(item[section].status)}" onclick="editStatus(${originalIndex}, '${section}')">${formatStatus(item[section].status)}</div>`
    ];
}

// =================================================================================
// Core Logic & Actions (AI, Bulk Updates)
// =================================================================================
function runAIAnalysis() {
    showNotification('ðŸ¤– Running AI analysis for all items...', 'info');
    showLoading(true);
    const { costingData } = getActiveSystemContext();
    
    if (!costingData || costingData.length === 0) {
        showLoading(false);
        showNotification('No data available to analyze.', 'info');
        return;
    }

    // Pass the entire costingData array to the backend for analysis.
    // The array is mapped to include the original index for each item.
    const itemsToAnalyze = costingData.map((item, index) => ({ ...item, originalIndex: index }));

    google.script.run
        .withSuccessHandler(handleAIAnalysisSuccess)
        .withFailureHandler(handleAIAnalysisFailure)
        .runOpenAIAnalysis(itemsToAnalyze);
}

function handleAIAnalysisSuccess(aiRecommendations) {
    showLoading(false);
    const { costingData, deviationFilterIds } = getActiveSystemContext();
    
    aiRecommendations.forEach(rec => {
        const item = costingData[rec.index];
        if (item) {
            item.ca.status = rec.status;
            item.toc.status = rec.status;
            item.time.status = rec.status;
            item.aiNotes = (item.aiNotes ? item.aiNotes + '\n' : '') + `AI: ${rec.decisionNotes}`;
        }
    });

    // Reset deviation filters to ensure all rows are visible
    for (const key in deviationFilterIds) {
        const sliderId = deviationFilterIds[key];
        const inputId = sliderId.replace('-filter-', '-input-');
        $(sliderId).val(0);
        $(inputId).val(0);
    }

    filterAndPopulate();
    showNotification('AI analysis complete. Table updated.', 'success');
}

function handleAIAnalysisFailure(error) {
    showLoading(false);
    console.error('AI Analysis Error:', error);
    showNotification('AI Analysis Failed: ' + error.message, 'error');
}

function bulkUpdateBenchmarks() {
    if (!confirm('Are you sure you want to bulk update all benchmarks for the visible rows?')) return;
    const { filteredData } = getActiveSystemContext();
    filteredData.forEach(item => {
        ['ca', 'toc', 'time'].forEach(sec => {
            item[sec].benchmark = item[sec].newBenchmark;
            item[sec].status = 'approved';
        });
    });
    filterAndPopulate();
    updateMLInsights();
    showNotification('Bulk benchmark update completed!', 'success');
}

function bulkUpdateStatus(section) {
    const status = $(`#${section}-bulk-status-${activeSystem}`).val();
    const { filteredData } = getActiveSystemContext();
    filteredData.forEach(item => item[section].status = status);
    filterAndPopulate();
    showNotification(`${section.toUpperCase()} statuses for visible rows updated!`, 'success');
}

// =================================================================================
// Data Persistence (Load/Save)
// =================================================================================
function refreshData() {
    const { importFunc } = getActiveSystemContext();
    showNotification(`Loading data for ${activeSystem.toUpperCase()}...`, 'info');
    showLoading(true);
    google.script.run.withSuccessHandler(data => {
        if (activeSystem === 'sfg') { sfgCostingData = data; sfgFilteredCostingData = data; sfgLastRefresh = new Date(); } 
        else { fgCostingData = data; fgFilteredCostingData = data; fgLastRefresh = new Date(); }
        filterAndPopulate(); updateMLInsights(); updateRefreshTimestamp();
        showLoading(false); showNotification('Data imported successfully!', 'success');
    }).withFailureHandler(error => {
        showLoading(false); showNotification('Import failed.', 'error');
    })[importFunc]();
}

function saveData() {
    const { costingData, saveFunc } = getActiveSystemContext();
    showNotification(`Saving data for ${activeSystem.toUpperCase()}...`, 'info');
    showLoading(true);
    
    google.script.run.withSuccessHandler(response => {
        showLoading(false);
        showNotification(response.message, 'success');

        // Filter out completed rows after successful save
        const remainingData = getActiveSystemContext().costingData.filter(item => {
            const caDone = item.ca.status !== 'action_required';
            const tocDone = item.toc.status !== 'action_required';
            const timeDone = item.time.status !== 'action_required';
            return !(caDone && tocDone && timeDone); // Keep item if any section still requires action
        });

        if (activeSystem === 'sfg') {
            sfgCostingData = remainingData;
        } else {
            fgCostingData = remainingData;
        }

        filterAndPopulate();
        updateMLInsights();

    }).withFailureHandler(error => {
        showLoading(false);
        showNotification('Save failed.', 'error');
    })[saveFunc](costingData);
}

// =================================================================================
// Inline Editing & Modal Logic
// =================================================================================
function openEditModal(rowIndex, fieldPath) {
    const { costingData } = getActiveSystemContext();
    currentEditContext = { rowIndex, fieldPath };
    const currentValue = getNestedValue(costingData[rowIndex], fieldPath);
    $('#edit-field').val(fieldPath);
    $('#edit-current-value').val(currentValue);
    $('#edit-new-value').val('').focus();
    $('#edit-modal').show();
}

function closeModal() {
    $('#edit-modal').hide();
    currentEditContext = null;
}

function saveEdit() {
    if (!currentEditContext) return;
    const { costingData } = getActiveSystemContext();
    const { rowIndex, fieldPath } = currentEditContext;
    const newValue = $('#edit-new-value').val();
    setNestedValue(costingData[rowIndex], fieldPath, newValue);
    filterAndPopulate();
    updateMLInsights();
    closeModal();
    showNotification('Data updated successfully!', 'success');
}

function editStatus(rowIndex, section) {
    const { costingData } = getActiveSystemContext();
    const item = costingData[rowIndex];
    const newStatus = item[section].status === 'update' ? 'no_need' : 'update';
    if (section === 'ca') {
        ['ca', 'toc', 'time'].forEach(sec => item[sec].status = newStatus);
    } else {
        item[section].status = newStatus;
    }
    filterAndPopulate();
    updateMLInsights();
    showNotification(`Status updated to: ${formatStatus(newStatus)}`, 'success');
}

// =================================================================================
// Event Listeners
// =================================================================================
function attachEventListeners() {
    // Tabs
    $('#sfg-tab').on('click', () => switchTab('sfg'));
    $('#fg-tab').on('click', () => switchTab('fg'));

    // Main Controls
    $('#sfg-run-ai-btn, #fg-run-ai-btn').on('click', runAIAnalysis);
    $('#sfg-bulk-update-btn, #fg-bulk-update-btn').on('click', bulkUpdateBenchmarks);
    $('#sfg-save-btn, #fg-save-btn').on('click', saveData);
    $('#sfg-refresh-btn, #fg-refresh-btn').on('click', refreshData);

    // Bulk Status
    ['sfg', 'fg'].forEach(sys => ['ca', 'toc', 'time'].forEach(sec => {
        $(`#${sys}-bulk-status-${sec}-btn`).on('click', () => bulkUpdateStatus(sec));
    }));

    // Deviation Filters
    ['sfg', 'fg'].forEach(sys => ['ca', 'toc', 'time'].forEach(sec => {
        const rangeSlider = $(`#${sec}-deviation-filter-${sys}`);
        const numberInput = $(`#${sec}-deviation-input-${sys}`);
        rangeSlider.on('input', () => { numberInput.val(rangeSlider.val()); if (activeSystem === sys) filterAndPopulate(); });
        numberInput.on('input', () => { rangeSlider.val(numberInput.val()); if (activeSystem === sys) filterAndPopulate(); });
    }));

    // Modal
    $('#modal-cancel-btn').on('click', closeModal);
    $('#modal-save-btn').on('click', saveEdit);
    $('#edit-new-value').on('keypress', e => { if (e.key === 'Enter') saveEdit(); });
}

// =================================================================================
// Helpers & Utilities
// =================================================================================
function getNestedValue(obj, path) { return path.split('.').reduce((o, p) => o && o[p], obj); }
function setNestedValue(obj, path, value) {
    const keys = path.split('.'); const last = keys.pop();
    const target = keys.reduce((o, k) => o[k], obj);
    target[last] = isNaN(value) || value === '' ? value : parseFloat(value);
}
function calculateDeviation(b, n) { return b === 0 ? 'N/A' : (((n - b) / b) * 100).toFixed(1) + '%'; }
function calculateTimeDeviation(b, n) {
    const bSec = timeToSeconds(b); const nSec = timeToSeconds(n);
    return bSec === 0 ? 'N/A' : (((nSec - bSec) / bSec) * 100).toFixed(1) + '%';
}
function timeToSeconds(t) { if (!t) return 0; const p = t.split(':'); return p.length !== 3 ? 0 : +p[0] * 3600 + +p[1] * 60 + +p[2]; }
function getStatusClass(s) { if (s === 'update') return 'status-update'; if (s === 'no_need') return 'status-no-need'; return 'status-action-required'; }
function formatStatus(s) { if (s === 'update') return 'Update'; if (s === 'no_need') return 'No Need'; return 'Action Required'; }
function showNotification(message, type = 'info') {
    const notification = $('<div></div>').addClass(`notification ${type}`).text(message);
    $('body').append(notification);
    setTimeout(() => notification.addClass('show'), 100);
    setTimeout(() => { notification.removeClass('show'); setTimeout(() => notification.remove(), 300); }, 3000);
}
function showLoading(show) { $('#loading-indicator').css('display', show ? 'block' : 'none'); }
function filterAndPopulate() {
    const { costingData, deviationFilterIds } = getActiveSystemContext();
    if (!costingData) return;
    const caDevFilter = parseFloat($(deviationFilterIds.ca).val());
    const tocDevFilter = parseFloat($(deviationFilterIds.toc).val());
    const timeDevFilter = parseFloat($(deviationFilterIds.time).val());
    const newFilteredData = costingData.filter(item => {
        const caDev = Math.abs(parseFloat(calculateDeviation(item.ca.benchmark, item.ca.newBenchmark))) || 0;
        const tocDev = Math.abs(parseFloat(calculateDeviation(item.toc.benchmark, item.toc.newBenchmark))) || 0;
        const timeDev = Math.abs(parseFloat(calculateTimeDeviation(item.time.benchmark, item.time.newBenchmark))) || 0;
        return caDev >= caDevFilter && tocDev >= tocDevFilter && timeDev >= timeDevFilter;
    });
    if (activeSystem === 'sfg') { sfgFilteredCostingData = newFilteredData; } else { fgFilteredCostingData = newFilteredData; }
    populateTable();
}
function updateMLInsights() {
    const { costingData } = getActiveSystemContext();
    if (!costingData) return;
    const totalItems = costingData.length;
    let deviationCount = 0, totalOptimization = 0;
    costingData.forEach(item => {
        if (item.ca.benchmark > 0) {
            const caDeviation = ((item.ca.newBenchmark - item.ca.benchmark) / item.ca.benchmark) * 100;
            if (Math.abs(caDeviation) > 5) deviationCount++;
            if (item.ca.newBenchmark < item.ca.benchmark) totalOptimization += item.ca.benchmark - item.ca.newBenchmark;
        }
        if (item.toc.benchmark > 0) {
            const tocDeviation = ((item.toc.newBenchmark - item.toc.benchmark) / item.toc.benchmark) * 100;
            if (Math.abs(tocDeviation) > 5) deviationCount++;
            if (item.toc.newBenchmark < item.toc.benchmark) totalOptimization += item.toc.benchmark - item.toc.newBenchmark;
        }
    });
    const optimizationPercentage = totalItems > 0 ? ((totalOptimization / (totalItems * 80)) * 100).toFixed(1) : 0;
    $('#optimization-potential').text(optimizationPercentage + '%');
    $('#updates-needed').text(deviationCount);
    $('#efficiency-score').text('87%');
    $('#variance-alert').text(deviationCount > 3 ? 'High' : deviationCount > 1 ? 'Medium' : 'Low');
}
</script>
